jQuery(document).ready(function($){var AffWP_Batch,AffWP_Batch_Import;AffWP_Batch={init:function(){this.submit()},submit:function(){var self=this,form=$(".affwp-batch-form");form.on("submit",function(event){event.preventDefault();var submitButton=$(this).find('input[type="submit"]');if(!submitButton.hasClass("button-disabled")){var ays=$(this).data("ays");if(void 0!==ays&&!confirm(ays))return;var data={batch_id:$(this).data("batch_id"),nonce:$(this).data("nonce"),form:$(this).serializeAssoc()};submitButton.addClass("button-disabled"),$(this).find(".notice-wrap").remove(),$(this).append('<div class="notice-wrap"><div class="affwp-batch-progress"><div></div></div></div>'),submitButton.parent().append('<span class="spinner is-active"></span>'),self.process_step(1,data,self)}})},process_step:function(step,data,self){var self=this;$.ajax({type:"POST",url:ajaxurl,data:{batch_id:data.batch_id,action:"process_batch_request",nonce:data.nonce,form:data.form,step:step,data:data},dataType:"json",success:function(response){if(response.data.done||response.data.error){var batchSelector=response.data.mapping?".affwp-batch-import-form":".affwp-batch-form",batchForm=$(batchSelector),spinner=batchForm.find(".spinner"),notice_wrap=batchForm.find(".notice-wrap");batchForm.find(".button-disabled").removeClass("button-disabled"),response.data.error?(spinner.remove(),notice_wrap.html('<div class="updated error"><p>'+response.data.error+"</p></div>")):response.data.done?(spinner.remove(),notice_wrap.html('<div id="affwp-batch-success" class="updated notice"><p class="affwp-batch-success">'+response.data.message+"</p></div>"),response.data.url&&(window.location=response.data.url)):notice_wrap.remove()}else $(".affwp-batch-progress div").animate({width:response.data.percentage+"%"},50,function(){}),self.process_step(parseInt(response.data.step),data,self)}}).fail(function(response){window.console&&window.console.log&&console.log(response)})}},AffWP_Batch.init(),AffWP_Batch_Import=$.extend({},AffWP_Batch,{submit:function(){var self=this;$(".affwp-batch-import-form").each(function(index,obj){$(this).ajaxForm({beforeSubmit:self.before_submit,complete:self.complete,dataType:"json",error:self.error,data:{action:"process_batch_import",batch_id:$(this).data("batch_id"),nonce:$(this).data("nonce")},url:ajaxurl,resetForm:!0})})},before_submit:function(arr,$form,options){if($form.find(".notice-wrap").remove(),$form.append('<div class="notice-wrap"><span class="spinner is-active"></span><div class="affwp-batch-progress"><div></div></div></div>'),!(window.File&&window.FileReader&&window.FileList&&window.Blob)){var import_form=$(".affwp-batch-import-form").find(".affwp-batch-progress").parent().parent(),notice_wrap=import_form.find(".notice-wrap");return import_form.find(".button-disabled").removeClass("button-disabled"),notice_wrap.html('<div class="update error"><p>'+affwp_batch_vars.unsupported_browser+"</p></div>"),!1}},success:function(responseText,statusText,xhr,$form){console.log($form)},complete:function(xhr){var response=jQuery.parseJSON(xhr.responseText),self=this;if(response.success){var $form=$(".affwp-batch-import-form .notice-wrap").parent();$form.find(".affwp-import-file-wrap, .notice-wrap").remove(),$form.find(".affwp-import-options").slideDown();var selectName,select=$form.find("select.affwp-import-csv-column"),options=(select.parent().parent(),""),columns=response.data.columns.sort(function(a,b){return a<b?-1:a>b?1:0});$.each(select,function(selectKey,selectValue){currentSelect=$(this),selectName=$(selectValue).attr("name"),$.each(columns,function(columnKey,columnValue){processedColumnValue=columnValue.toLowerCase().replace(/ /g,"_"),columnRegex=new RegExp("\\["+processedColumnValue+"\\]"),selectName.length&&selectName.match(columnRegex)?(options+='<option value="'+columnValue+'" selected="selected">'+columnValue+"</option>",0!=response.data.first_row[columnValue]?currentSelect.parent().next().html(response.data.first_row[columnValue]):currentSelect.parent().next().html("")):options+='<option value="'+columnValue+'">'+columnValue+"</option>"}),$(this).append(options),options=""}),select.on("change",function(){var $key=$(this).val();$key&&0!=response.data.first_row[$key]?$(this).parent().next().html(response.data.first_row[$key]):$(this).parent().next().html("")}),$("body").on("click",".affwp-import-proceed",function(event){if(event.preventDefault(),$form.data("required")){var required=$form.data("required"),requiredFields=[];requiredFields=required.indexOf(",")?required.split(","):[required];var triggerValidation=!1;if($.each(requiredFields,function(key,value){field=$("select[name='affwp-import-field["+value+"]']"),tableRow=field.parent().parent(),tableRow.removeClass("affwp-required-import-field"),""==field.val()&&(triggerValidation=!0,tableRow.addClass("affwp-required-import-field"),field.parent().next().html(affwp_batch_vars.import_field_required))}),triggerValidation)return}$form.find(".notice-wrap").remove(),$(this).parent().append('<span class="spinner is-active"></span>'),$form.append('<div class="notice-wrap"><div class="affwp-batch-progress"><div></div></div></div>'),response.data.mapping=$form.serialize(),response.data.form=$form.serializeAssoc(),AffWP_Batch.process_step(1,response.data,self)})}else self.error(xhr)},error:function(xhr){var response=jQuery.parseJSON(xhr.responseText),import_form=$(".affwp-batch-import-form").find(".affwp-batch-progress").parent().parent(),notice_wrap=import_form.find(".notice-wrap");import_form.find(".button-disabled").removeClass("button-disabled"),response.data.error?notice_wrap.html('<div class="update error"><p>'+response.data.error+"</p></div>"):notice_wrap.remove()}}),AffWP_Batch_Import.init(),$.extend({isArray:function(arr){return!(!arr||"object"!=typeof arr||arr.constructor!=Array)},arrayMerge:function(){for(var a={},n=0,argv=$.arrayMerge.arguments,i=0;i<argv.length;i++)if($.isArray(argv[i])){for(var j=0;j<argv[i].length;j++)a[n++]=argv[i][j];a=$.makeArray(a)}else for(var k in argv[i])if(isNaN(k)){var v=argv[i][k];"object"==typeof v&&a[k]&&(v=$.arrayMerge(a[k],v)),a[k]=v}else a[n++]=argv[i][k];return a},count:function(arr){if($.isArray(arr))return arr.length;var n=0;for(var k in arr)isNaN(k)||n++;return n}}),$.fn.extend({serializeAssoc:function(){for(var o={aa:{},add:function(name,value){var tmp=name.match(/^(.*)\[([^\]]*)\]$/);if(tmp){var v={};tmp[2]?v[tmp[2]]=value:v[$.count(v)]=value,this.add(tmp[1],v)}else"object"==typeof value?("object"!=typeof this.aa[name]&&(this.aa[name]={}),this.aa[name]=$.arrayMerge(this.aa[name],value)):this.aa[name]=value}},a=$(this).serializeArray(),i=0;i<a.length;i++)o.add(a[i].name,a[i].value);return o.aa}})});