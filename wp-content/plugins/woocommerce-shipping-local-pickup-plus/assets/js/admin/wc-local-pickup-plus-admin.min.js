(function() {  "use strict";

  /**
   * WooCommerce Local Pickup Plus admin scripts.
   *
   * General handler of Local Pickup Plus admin screens, where JS is needed to
   * enhance the user interface, initialize enhanced search fields and the behavior
   * of meta-boxes, fire some AJAX requests, etc.
   *
   * @since 2.0.0
   */
  jQuery(document).ready(function($) {
    var $apiKeyField, $appointmentsMode, $cartItemHandlingMode, $cartItemHandlingRow, $checkoutLocationMode, $defaultHandlingRow, $defaultOpt, $distanceOpt, $form, $goBack, $header, $locationSortOrder, $loggingField, $loggingInput, $pickupDataField, $pickupDateCalendars, $searchPickupLocations, $sortingDesc, getEnhancedSelectFormatString, pagenow, ref, ref1, wc_local_pickup_plus_admin;
    wc_local_pickup_plus_admin = (ref = window.wc_local_pickup_plus_admin) != null ? ref : {};
    pagenow = (ref1 = window.pagenow) != null ? ref1 : '';

    /**
    	 * Duplicate of `getEnhancedSelectFormatString` from wc-enhanced-select.js, because WooCommerce does not expose the function globally.
    	 *
    	 * @see wc_local_pickup_plus_admin.initializeEnhancedSelect() below.
    	 *
    	 * @since 2.0.0
     */
    getEnhancedSelectFormatString = function() {
      var formatString;
      formatString = {
        formatMatches: function(matches) {
          if (1 === matches) {
            return wc_enhanced_select_params.i18n_matches_1;
          }
          return wc_enhanced_select_params.i18n_matches_n.replace('%qty%', matches);
        },
        formatNoMatches: function() {
          return wc_enhanced_select_params.i18n_no_matches;
        },
        formatAjaxError: function(jqXHR, textStatus, errorThrown) {
          return wc_enhanced_select_params.i18n_ajax_error;
        },
        formatInputTooShort: function(input, min) {
          var number;
          number = min - input.length;
          if (1 === number) {
            return wc_enhanced_select_params.i18n_input_too_short_1;
          }
          return wc_enhanced_select_params.i18n_input_too_short_n.replace('%qty%', number);
        },
        formatInputTooLong: function(input, max) {
          var number;
          number = input.length - max;
          if (1 === number) {
            return wc_enhanced_select_params.i18n_input_too_long_1;
          }
          return wc_enhanced_select_params.i18n_input_too_long_n.replace('%qty%', number);
        },
        formatSelectionTooBig: function(limit) {
          if (1 === limit) {
            return wc_enhanced_select_params.i18n_selection_too_long_1;
          }
          return wc_enhanced_select_params.i18n_selection_too_long_n.replace('%qty%', limit);
        },
        formatLoadMore: function(pageNumber) {
          return wc_enhanced_select_params.i18n_load_more;
        },
        formatSearching: function() {
          return wc_enhanced_select_params.i18n_searching;
        }
      };
      return formatString;
    };

    /**
    	 * Initialize enhanced select2 for an element.
    	 *
    	 * We use select2 to search pickup locations by AJAX in the admin.
    	 *
    	 * @since 2.0.0
    	 *
    	 * @param {object} el HTML select element DOM object
    	 * @param {object} params optional: AJAX request data params
     */
    wc_local_pickup_plus_admin.initializeEnhancedSelect = function(el, params) {
      var select2_args;
      if ($(el).is('.enhanced')) {
        $(el).removeClass("enhanced");
      }
      if (wc_local_pickup_plus_admin.select2_version === '3.5.3') {
        select2_args = {
          allowClear: $(el).data('allow_clear') ? true : false,
          placeholder: $(el).data('placeholder'),
          minimumInputLength: $(el).data('minimum_input_length') ? $(el).data('minimum_input_length') : '3',
          escapeMarkup: function(m) {
            return m;
          },
          ajax: {
            url: wc_local_pickup_plus_admin.ajax_url,
            cache: false,
            dataType: 'json',
            quietMillis: 250,
            data: function(term, page) {
              return $.extend({
                term: term
              }, params);
            },
            results: function(data, page) {
              var terms;
              terms = [];
              if (data) {
                $.each(data, function(id, text) {
                  return terms.push({
                    id: id,
                    text: text
                  });
                });
              }
              return {
                results: terms
              };
            }
          }
        };
        if ($(el).data('multiple') === true) {
          select2_args.multiple = true;
          select2_args.initSelection = function(element, callback) {
            var data, selected;
            data = $.parseJSON(element.attr('data-selected'));
            selected = [];
            $(element.val().split(",")).each(function(i, val) {
              return selected.push({
                id: val,
                text: data[val]
              });
            });
            return callback(selected);
          };
          select2_args.formatSelection = function(data) {
            return '<div class="selected-option" data-id="' + data.id + '">' + data.text + '</div>';
          };
        } else {
          select2_args.multiple = false;
          select2_args.initSelection = function(element, callback) {
            var data;
            data = {
              id: element.val(),
              text: element.attr('data-selected')
            };
            return callback(data);
          };
        }
      } else {
        select2_args = {
          allowClear: $(el).data('allow_clear') ? true : false,
          placeholder: $(el).data('placeholder'),
          minimumInputLength: $(el).data('minimum_input_length') ? $(el).data('minimum_input_length') : '3',
          escapeMarkup: function(m) {
            return m;
          },
          ajax: {
            url: wc_local_pickup_plus_admin.ajax_url,
            cache: false,
            dataType: 'json',
            delay: 250,
            data: function(args) {
              return $.extend({
                term: args.term
              }, params);
            },
            processResults: function(data, page) {
              var terms;
              terms = [];
              if (data) {
                $.each(data, function(id, text) {
                  return terms.push({
                    id: id,
                    text: text
                  });
                });
              }
              return {
                results: terms
              };
            }
          }
        };
      }
      select2_args = $.extend(select2_args, getEnhancedSelectFormatString());
      return $(el).select2(select2_args).addClass('enhanced');
    };
    if ('woocommerce_page_wc-settings' === pagenow) {
      $checkoutLocationMode = $('#woocommerce_local_pickup_plus_enable_per_item_selection');
      $cartItemHandlingMode = $('#woocommerce_local_pickup_plus_item_handling');
      if ($checkoutLocationMode && $cartItemHandlingMode) {
        $cartItemHandlingRow = $cartItemHandlingMode.closest('td').parent();
        $defaultHandlingRow = $('#woocommerce_local_pickup_plus_default_handling').closest('td').parent();
        $checkoutLocationMode.on('change', function(e) {
          if ($(this).val() === 'per-order') {
            $cartItemHandlingRow.show();
            return $defaultHandlingRow.show();
          } else {
            $cartItemHandlingRow.hide();
            return $defaultHandlingRow.hide();
          }
        });
        $checkoutLocationMode.trigger('change');
        $cartItemHandlingMode.trigger('change');
      }
      $locationSortOrder = $('#woocommerce_local_pickup_plus_pickup_locations_sort_order');
      if ($locationSortOrder) {
        $apiKeyField = $('#woocommerce_local_pickup_plus_google_maps_api_key');
        $loggingInput = $('#woocommerce_local_pickup_plus_enable_logging');
        $loggingField = $loggingInput.closest('tr');
        $distanceOpt = $locationSortOrder.find('option[value="distance_customer"]');
        $defaultOpt = $locationSortOrder.find('option[value="default"]');
        $sortingDesc = $locationSortOrder.next('p.description');
        if ($apiKeyField && $distanceOpt && $defaultOpt) {
          $apiKeyField.on('change keyup paste', function(e) {
            if ($(this).val() === '') {
              $loggingInput.prop('checked', false);
              $loggingField.hide();
              $sortingDesc.show();
              if ($locationSortOrder.val() === 'distance_customer') {
                $locationSortOrder.val('default');
                $locationSortOrder.trigger('change');
              }
              return $distanceOpt.prop('disabled', 'disabled');
            } else {
              $distanceOpt.removeProp('disabled');
              $loggingField.show();
              return $sortingDesc.hide();
            }
          });
          $apiKeyField.trigger('change');
        }
        $locationSortOrder.trigger('change');
      }
      $appointmentsMode = $('#woocommerce_local_pickup_plus_pickup_appointments_mode');
      if ($appointmentsMode) {
        $appointmentsMode.on('change', function(e) {
          var $businessHours, $pickupDeadline, $pickupLeadTime, $publicHolidays;
          $businessHours = $('.wc-local-pickup-plus-business-hours-field').closest('td').parent();
          $publicHolidays = $('#woocommerce_local_pickup_plus_default_public_holidays').closest('td').parent();
          $pickupLeadTime = $('#woocommerce_local_pickup_plus_default_lead_time_amount').closest('td').parent();
          $pickupDeadline = $('#woocommerce_local_pickup_plus_default_deadline_amount').closest('td').parent();
          if ($(this).val() === 'disabled') {
            $businessHours.hide();
            $publicHolidays.hide();
            $pickupLeadTime.hide();
            return $pickupDeadline.hide();
          } else {
            $businessHours.show();
            $publicHolidays.show();
            $pickupLeadTime.show();
            return $pickupDeadline.show();
          }
        });
        $appointmentsMode.trigger('change');
      }
    }
    if ('wc_pickup_location' === pagenow) {
      $('#edit-pickup-location-coordinates').on('click', function(e) {
        return $('.edit-pickup-location-coordinates').toggle();
      });
      $('#_products_availability_mode').on('change', function(e) {
        if ($(this).val() === 'any') {
          $('.js-show-if-products-availability-is-some').hide();
          return $('.js-show-if-products-availability-is-any').show();
        } else {
          $('.js-show-if-products-availability-is-some').show();
          return $('.js-show-if-products-availability-is-any').hide();
        }
      });
      $('#pickup-location-products button').on('click', function(e) {
        var $container, $fieldContainer, $inputField;
        e.preventDefault();
        $container = $(this).parent('p');
        $inputField = $container.find('.js-search-products');
        $fieldContainer = $container.find('> span');
        $(this).hide();
        $(this).prev('button').show();
        $(this).next('button').show();
        if ($(this).hasClass('js-add-products') || $(this).hasClass('js-add-product-categories')) {
          return $fieldContainer.show();
        } else {
          $inputField.val('').trigger('change');
          return $fieldContainer.hide();
        }
      });
      $('#_price_adjustment_enabled').on('click', function(e) {
        var $price_adjustment;
        $price_adjustment = $('.js-show-if-price-adjustment-enabled');
        if ($(this).is(':checked')) {
          return $price_adjustment.show();
        } else {
          return $price_adjustment.hide();
        }
      });
      $('#_business_hours_enabled').on('click', function(e) {
        var $business_hours;
        $business_hours = $('.js-show-if-business-hours-enabled');
        if ($(this).is(':checked')) {
          return $business_hours.show();
        } else {
          return $business_hours.hide();
        }
      });
      $('#_public_holidays_enabled').on('click', function(e) {
        var $public_holidays;
        $public_holidays = $('.js-show-if-public-holidays-enabled');
        if ($(this).is(':checked')) {
          return $public_holidays.show();
        } else {
          return $public_holidays.hide();
        }
      });
      $('#_pickup_lead_time_enabled').on('click', function(e) {
        var $lead_time;
        $lead_time = $('.js-show-if-lead-time-enabled');
        if ($(this).is(':checked')) {
          return $lead_time.show();
        } else {
          return $lead_time.hide();
        }
      });
      $('#_pickup_deadline_enabled').on('click', function(e) {
        var $deadline;
        $deadline = $('.js-show-if-deadline-enabled');
        if ($(this).is(':checked')) {
          return $deadline.show();
        } else {
          return $deadline.hide();
        }
      });
      $('ul.wc-tabs').show();
      $('div.panel-wrap').each(function() {
        return $(this).find('div.panel:not(:first)').hide();
      });
      $('ul.wc-tabs a').click(function() {
        var panel_wrap, target;
        target = $(this).attr('href');
        panel_wrap = $(this).closest('div.panel-wrap');
        $('ul.wc-tabs li', panel_wrap).removeClass('active');
        $(this).parent().addClass('active');
        $('div.panel', panel_wrap).hide();
        return $(target).show();
      });
      $('ul.wc-tabs li:visible').eq(0).find('a').click();
    }
    if ('admin_page_wc_local_pickup_plus_export' === pagenow || 'admin_page_wc_local_pickup_plus_import' === pagenow) {
      $form = $('.wc-local-pickup-plus > form');
      $header = $form.find('h2');
      $goBack = $form.find('.wc-admin-breadcrumb');
      $goBack.show();
      $goBack.appendTo($header);
    }
    if ('edit-shop_order' === pagenow || 'woocommerce_page_wc_customer_order_csv_export' === pagenow || 'woocommerce_page_wc_customer_order_xml_export_suite' === pagenow) {
      $searchPickupLocations = $('.wc-local-pickup-plus-pickup-location-search');
      if ($searchPickupLocations) {
        wc_local_pickup_plus_admin.initializeEnhancedSelect($searchPickupLocations, {
          action: 'wc_local_pickup_plus_json_search_pickup_location_ids',
          security: wc_local_pickup_plus_admin.search_pickup_locations_nonce
        });
      }
    }
    if (pagenow === 'shop_order') {
      $pickupDataField = $('.wc-local-pickup-plus-order-shipping-item-pickup-data');
      if ($pickupDataField) {
        $searchPickupLocations = $pickupDataField.find('.wc-local-pickup-plus-pickup-location-search');
        $pickupDateCalendars = $pickupDataField.find('input.pickup-date');
        if ($searchPickupLocations) {
          wc_local_pickup_plus_admin.initializeEnhancedSelect($searchPickupLocations, {
            action: 'wc_local_pickup_plus_json_search_pickup_location_ids',
            security: wc_local_pickup_plus_admin.search_pickup_locations_nonce
          });
        }
        if ($pickupDateCalendars) {
          return $pickupDateCalendars.datepicker({
            'dateFormat': 'yy-mm-dd'
          });
        }
      }
    }
  });

}).call(this);


